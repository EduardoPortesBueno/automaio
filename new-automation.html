<!doctype html>
<html lang="pt-BR">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Automa.io - Request Automation</title>

    <link href="../css/style.css" rel="stylesheet" />
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css"
    />
  </head>
  <body class="bg-light">
    <header>
      <nav class="navbar navbar-expand-lg bg-white border-bottom shadow-sm">
        <div class="container">
          <a class="navbar-brand fw-bold" href="index.html">Automa.io</a>
          <button
            class="navbar-toggler"
            type="button"
            data-bs-toggle="collapse"
            data-bs-target="#navbarApp"
          >
            <span class="navbar-toggler-icon"></span>
          </button>
          <div class="collapse navbar-collapse" id="navbarApp">
            <ul class="navbar-nav mx-auto mb-2 mb-lg-0">
              <li class="nav-item">
                <a class="nav-link" href="index.html">Home</a>
              </li>
              <li class="nav-item">
                <a class="nav-link" href="automations.html">Automations</a>
              </li>
              <li class="nav-item">
                <a class="nav-link" href="docs.html">Docs</a>
              </li>
              <li class="nav-item">
                <a class="nav-link" href="community.html">Community</a>
              </li>
              <li class="nav-item">
                <a class="nav-link" href="templates.html">Templates</a>
              </li>
            </ul>
            <div class="d-flex align-items-center">
              <a href="new-automation.html" class="btn btn-primary me-2"
                >New automation</a
              >

              <div class="dropdown">
                <a
                  href="#"
                  class="text-decoration-none dropdown-toggle"
                  data-bs-toggle="dropdown"
                >
                  <i class="bi bi-person-circle text-primary fs-1"></i>
                </a>
                <ul class="dropdown-menu dropdown-menu-end shadow-sm">
                  <li><a class="dropdown-item" href="#">Meu Perfil</a></li>
                  <li><hr class="dropdown-divider" /></li>
                  <li>
                    <a class="dropdown-item" href="#" id="logout-button"
                      >Sair (Logout)</a
                    >
                  </li>
                </ul>
              </div>
            </div>
          </div>
        </div>
      </nav>
    </header>

    <main>
      <section class="py-5">
        <div class="container">
          <div class="row justify-content-center">
            <div class="col-12 col-lg-8">
              <div class="mb-4">
                <h1 class="h2">Request an automation</h1>
              </div>

              <form
                class="bg-white p-4 p-md-5 rounded shadow-sm needs-validation"
                id="newAutomationForm"
                novalidate
              >
                <div class="mb-3">
                  <label for="companySelect" class="form-label"
                    >Select company</label
                  >
                  <select
                    class="form-select form-select-lg"
                    id="companySelect"
                    required
                  >
                    <option selected disabled value="">Select company</option>
                    <option value="1">Company One</option>
                    <option value="2">Company Two</option>
                    <option value="3">Company Three</option>
                  </select>
                  <div class="invalid-feedback">
                    Por favor, selecione uma empresa.
                  </div>
                </div>

                <div class="mb-4">
                  <label for="automationName" class="form-label"
                    >Automation name</label
                  >
                  <input
                    type="text"
                    class="form-control form-control-lg"
                    id="automationName"
                    placeholder="Automation name"
                    required
                  />
                  <div class="invalid-feedback">
                    Por favor, dê um nome para a automação.
                  </div>
                </div>

                <div class="mb-4">
                  <label class="form-label">Select systems to integrate</label>
                  <div class="d-flex flex-wrap gap-2">
                    <a
                      href="#"
                      class="btn btn-outline-primary btn-icon-text"
                      data-bs-toggle="button"
                      ><i class="bi bi-building"></i> System A</a
                    >
                    <a
                      href="#"
                      class="btn btn-outline-primary btn-icon-text"
                      data-bs-toggle="button"
                      ><i class="bi bi-building"></i> System B</a
                    >
                    <a
                      href="#"
                      class="btn btn-outline-primary btn-icon-text"
                      data-bs-toggle="button"
                      ><i class="bi bi-building"></i> System C</a
                    >
                    <a
                      href="#"
                      class="btn btn-outline-primary btn-icon-text"
                      data-bs-toggle="button"
                      ><i class="bi bi-building"></i> System D</a
                    >
                    <a
                      href="#"
                      class="btn btn-outline-primary btn-icon-text"
                      data-bs-toggle="button"
                      ><i class="bi bi-building"></i> System E</a
                    >
                    <a
                      href="#"
                      class="btn btn-outline-primary btn-icon-text"
                      data-bs-toggle="button"
                      ><i class="bi bi-building"></i> System F</a
                    >
                    <a
                      href="#"
                      class="btn btn-outline-primary btn-icon-text"
                      data-bs-toggle="button"
                      ><i class="bi bi-building"></i> System G</a
                    >
                    <a
                      href="#"
                      class="btn btn-outline-primary btn-icon-text"
                      data-bs-toggle="button"
                      ><i class="bi bi-building"></i> System H</a
                    >
                  </div>
                </div>

                <div class="mb-4">
                  <label for="description" class="form-label"
                    >Description</label
                  >
                  <textarea
                    class="form-control form-control-lg"
                    id="description"
                    rows="5"
                    placeholder="Description"
                    required
                  ></textarea>
                  <div class="invalid-feedback">
                    Por favor, adicione uma descrição.
                  </div>
                </div>

                <div class="text-end">
                  <button type="submit" class="btn btn-primary btn-lg">
                    Submit
                  </button>
                </div>
              </form>
            </div>
          </div>
        </div>
      </section>
    </main>

    <div class="position-fixed bottom-0 end-0 p-3" style="z-index: 1030">
      <div class="collapse position-relative" id="chatWidget">
        <div class="card shadow-lg" style="width: 350px; margin-bottom: 1rem">
          <div
            class="card-header d-flex justify-content-between align-items-center"
          >
            <h6 class="mb-0 fw-bold">Ajuda & Suporte</h6>
            <a
              href="#chatWidget"
              class="btn-close"
              data-bs-toggle="collapse"
              aria-label="Close"
            ></a>
          </div>
          <div class="card-body" style="height: 300px; overflow-y: auto">
            <div class="d-flex mb-3">
              <div class="flex-shrink-0">
                <i class="bi bi-robot fs-3 text-primary"></i>
              </div>
              <div class="flex-grow-1 ms-3">
                <div class="bg-light p-3 rounded">
                  <p class="mb-0">Olá! Como posso ajudar?</p>
                </div>
              </div>
            </div>
          </div>
          <div class="card-footer">
            <div class="input-group">
              <input
                type="text"
                class="form-control"
                placeholder="Digite sua mensagem..."
              />
              <button class="btn btn-primary">
                <i class="bi bi-send-fill"></i>
              </button>
            </div>
          </div>
        </div>
      </div>
      <a
        class="btn btn-primary btn-lg rounded-circle shadow-lg float-end"
        data-bs-toggle="collapse"
        href="#chatWidget"
      >
        <i class="bi bi-chat-dots-fill"></i>
      </a>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

    <script type="module">
      import { AuthService } from '../services/auth.service.js';
      import { AutomationService } from '../services/automation.service.js';

      const authService = new AuthService();
      const automationService = new AutomationService();

      authService.protectRoute();

      document
        .getElementById('logout-button')
        ?.addEventListener('click', (e) => {
          e.preventDefault();
          authService.logout();
          alert('Você foi desconectado com sucesso.');
          window.location.href = 'index.html';
        });

      const form = document.getElementById('newAutomationForm');

      form.addEventListener('submit', async (event) => {
        event.preventDefault();
        event.stopPropagation();

        if (form.checkValidity()) {
          const company = document.getElementById('companySelect').value;
          const name = document.getElementById('automationName').value;
          const description = document.getElementById('description').value;

          const systemButtons = document.querySelectorAll(
            '.btn-icon-text.active'
          );
          const systems = Array.from(systemButtons).map((btn) =>
            btn.textContent.trim()
          );

          const automationData = {
            company,
            name,
            description,
            systems,
          };

          try {
            await automationService.createAutomation(automationData);
            alert('Automação criada com sucesso!');
            window.location.href = 'automations.html';
          } catch (error) {
            alert(
              'Erro ao salvar. Verifique se a API (npm run server) está rodando.'
            );
          }
        }
        form.classList.add('was-validated');
      });
    </script>
  </body>
</html>
